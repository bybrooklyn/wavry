name: Platform Builds

on:
  pull_request:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: platform-builds-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RELEASE_ICON_PATH: crates/wavry-desktop/src-tauri/icons/icon.png
  RELEASE_ICON_NAME: WavryLogo.png
  MACOSX_DEPLOYMENT_TARGET: "14.0"

jobs:
  pre-build:
    name: Prepare build
    runs-on: ubuntu-latest
    outputs:
      wavry_version: ${{ steps.version.outputs.wavry_version }}
      rift_version: ${{ steps.version.outputs.rift_version }}
      delta_version: ${{ steps.version.outputs.delta_version }}
      already_released: ${{ steps.check_release.outputs.already_released }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse VERSION file
        id: version
        run: |
          WAVRY_V=$(grep "WAVRY" VERSION | awk '{print $2}' | sed 's/^v//')
          RIFT_V=$(grep "RIFT" VERSION | awk '{print $2}' | sed 's/^v//')
          DELTA_V=$(grep "DELTA" VERSION | awk '{print $2}' | sed 's/^v//')
          echo "wavry_version=$WAVRY_V" >> $GITHUB_OUTPUT
          echo "rift_version=$RIFT_V" >> $GITHUB_OUTPUT
          echo "delta_version=$DELTA_V" >> $GITHUB_OUTPUT
          echo "WAVRY_V=$WAVRY_V" >> $GITHUB_ENV
          echo "Extracted Wavry Version: $WAVRY_V"

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if version already released
        id: check_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="v${{ env.WAVRY_V }}"
          if gh release view "$VERSION" >/dev/null 2>&1; then
            echo "Version $VERSION already exists in releases."
            if [[ "${{ github.ref_type }}" == "tag" ]]; then
              echo "Git tag detected, proceeding with build anyway."
              echo "already_released=false" >> $GITHUB_OUTPUT
            else
              echo "Skipping build for existing version."
              echo "already_released=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "Version $VERSION does not exist yet."
            echo "already_released=false" >> $GITHUB_OUTPUT
          fi

  rust-tests:
    name: Rust tests
    needs: pre-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config protobuf-compiler libsqlite3-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libasound2-dev libx11-dev libxtst-dev libxrandr-dev libxi-dev libevdev-dev libudev-dev libgtk-3-dev libwebkit2gtk-4.1-dev libsoup-3.0-dev libayatana-appindicator3-dev librsvg2-dev libgl-dev
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-${{ runner.os }}-workspace
      - name: Run tests
        run: cargo test --workspace --locked

  smoke-tests:
    name: Smoke tests
    needs: pre-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config protobuf-compiler libsqlite3-dev curl
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-${{ runner.os }}-workspace
      - name: Provision Secrets
        run: ./scripts/provision-infrastructure.sh ./secrets
      - name: Gateway Auth Smoke
        run: |
          source ./secrets/wavry.env
          ./scripts/gateway-auth-smoke.sh
      - name: Master/Relay Smoke
        run: |
          source ./secrets/wavry.env
          ./scripts/master-relay-smoke.sh

  rust-backend:
    name: Build backend (${{ matrix.suffix }}-${{ matrix.arch }})
    needs: pre-build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            suffix: linux
            arch: x86_64
            exe: ""
          - os: macos-14
            suffix: macos
            arch: arm64
            exe: ""
          - os: windows-latest
            suffix: windows
            arch: x86_64
            exe: ".exe"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config protobuf-compiler libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libasound2-dev libx11-dev libxtst-dev libxrandr-dev libxi-dev libevdev-dev libudev-dev libsqlite3-dev libgtk-3-dev libwebkit2gtk-4.1-dev libsoup-3.0-dev libayatana-appindicator3-dev librsvg2-dev libgl-dev
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-${{ runner.os }}-workspace
      - name: Build
        run: cargo build --release --locked -p wavry-master -p wavry-gateway -p wavry-relay -p wavry-server
      - name: Stage
        shell: bash
        run: |
          mkdir -p ci-artifacts/backend
          bins=(wavry-master wavry-gateway wavry-relay wavry-server)
          for b in "${bins[@]}"; do
            src="target/release/${b}${{ matrix.exe }}"
            dst="ci-artifacts/backend/${b}-${{ matrix.suffix }}-${{ matrix.arch }}${{ matrix.exe }}"
            if [[ ! -f "$src" ]]; then
              echo "Expected backend binary missing: $src" >&2
              exit 1
            fi
            cp "$src" "$dst"
          done
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.suffix }}-${{ matrix.arch }}-v${{ needs.pre-build.outputs.wavry_version }}
          path: ci-artifacts/backend/

  desktop-tauri:
    name: Desktop build (${{ matrix.suffix }}-${{ matrix.arch }})
    needs: pre-build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            suffix: linux
            arch: x86_64
            exe: ""
          - os: macos-14
            suffix: macos
            arch: arm64
            exe: ""
          - os: windows-latest
            suffix: windows
            arch: x86_64
            exe: ".exe"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install Bun
        uses: oven-sh/setup-bun@v2
      - name: Cache frontend dependencies
        uses: actions/cache@v4
        with:
          path: crates/wavry-desktop/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('crates/wavry-desktop/bun.lock', 'crates/wavry-desktop/package.json') }}
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config protobuf-compiler libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libasound2-dev libx11-dev libxtst-dev libxrandr-dev libxi-dev libevdev-dev libudev-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev patchelf libwebkit2gtk-4.1-dev libsoup-3.0-dev libgl-dev || sudo apt-get install -y libwebkit2gtk-4.0-dev
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-${{ runner.os }}-workspace
          workspaces: |
            . -> target
            crates/wavry-desktop/src-tauri -> target
      - name: Install frontend dependencies
        working-directory: crates/wavry-desktop
        run: bun install --frozen-lockfile
      - name: Build (macOS DMG bundle)
        if: runner.os == 'macOS'
        working-directory: crates/wavry-desktop
        run: bun run tauri build --bundles dmg --no-sign --ci
      - name: Build (non-macOS binary)
        if: runner.os != 'macOS'
        working-directory: crates/wavry-desktop
        run: bun run tauri build --no-bundle --ci
      - name: Stage macOS desktop DMG
        if: runner.os == 'macOS'
        shell: bash
        run: |
          mkdir -p ci-artifacts/desktop
          dmg_path=""
          app_path=""
          for root in "target/release" "crates/wavry-desktop/src-tauri/target/release"; do
            if [[ -d "$root/bundle/dmg" ]]; then
              dmg_path="$(find "$root/bundle/dmg" -maxdepth 1 -type f -name "*.dmg" 2>/dev/null | head -n 1 || true)"
              if [[ -n "$dmg_path" ]]; then
                break
              fi
            fi
            if [[ -z "$app_path" && -d "$root/bundle/macos" ]]; then
              app_path="$(find "$root/bundle/macos" -maxdepth 1 -type d -name "*.app" 2>/dev/null | head -n 1 || true)"
            fi
          done

          out_dmg="ci-artifacts/desktop/wavry-desktop-tauri-${{ matrix.suffix }}-${{ matrix.arch }}.dmg"
          if [[ -n "$dmg_path" ]]; then
            cp "$dmg_path" "$out_dmg"
            exit 0
          fi

          if [[ -n "$app_path" ]]; then
            echo "No bundled DMG found; creating DMG from app bundle: $app_path"
            hdiutil create \
              -volname "Wavry Desktop" \
              -srcfolder "$app_path" \
              -ov \
              -format UDZO \
              "$out_dmg"
            exit 0
          fi

          echo "No desktop DMG or .app bundle found in expected output paths" >&2
          for root in "target/release" "crates/wavry-desktop/src-tauri/target/release"; do
            if [[ -d "$root/bundle" ]]; then
              echo "Bundle contents under $root/bundle:" >&2
              find "$root/bundle" -maxdepth 2 -print >&2 || true
            fi
          done
          exit 1
      - name: Stage non-macOS desktop binary
        if: runner.os != 'macOS'
        shell: bash
        run: |
          mkdir -p ci-artifacts/desktop
          found=""
          for root in "target/release" "crates/wavry-desktop/src-tauri/target/release"; do
            for name in wavry-desktop wavry_desktop; do
              if [[ -f "$root/${name}${{ matrix.exe }}" ]]; then
                cp "$root/${name}${{ matrix.exe }}" "ci-artifacts/desktop/wavry-desktop-${{ matrix.suffix }}${{ matrix.exe }}"
                found="1"
                break
              fi
            done
            if [[ -n "$found" ]]; then
              break
            fi
          done
          if [[ -z "$found" ]]; then
            echo "No desktop binary found in expected output paths" >&2
            exit 1
          fi
          mv "ci-artifacts/desktop/wavry-desktop-${{ matrix.suffix }}${{ matrix.exe }}" \
             "ci-artifacts/desktop/wavry-desktop-tauri-${{ matrix.suffix }}-${{ matrix.arch }}${{ matrix.exe }}"
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.suffix }}-${{ matrix.arch }}-v${{ needs.pre-build.outputs.wavry_version }}
          path: ci-artifacts/desktop/

  android:
    name: Android build
    needs: pre-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: 'gradle'
      - name: Setup SDK
        uses: android-actions/setup-android@v3
      
      - name: Cache NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: /usr/local/lib/android/sdk/ndk/26.3.11579264
          key: ndk-26.3.11579264

      - name: Install NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: sdkmanager --install "ndk;26.3.11579264" "cmake;3.22.1"
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android, x86_64-linux-android
      
      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-${{ runner.os }}-android
          key: android-target

      - name: Cache cargo-ndk
        id: cache-cargo-ndk
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-ndk
          key: cargo-ndk-${{ runner.os }}-3

      - name: Install cargo-ndk
        if: steps.cache-cargo-ndk.outputs.cache-hit != 'true'
        run: cargo install cargo-ndk

      - name: Build
        run: ./scripts/dev-android.sh --both --release --no-install --no-ndk-install
      - name: Stage
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          mkdir -p ci-artifacts/android
          mobile_apk="$(find apps/android/app/build/outputs -type f -name "app-mobile-release.apk" | head -n 1 || true)"
          quest_apk="$(find apps/android/app/build/outputs -type f -name "app-quest-release.apk" | head -n 1 || true)"

          if [[ -n "$mobile_apk" ]]; then
            cp "$mobile_apk" "ci-artifacts/android/wavry-mobile-android-arm64-release.apk"
          fi
          if [[ -n "$quest_apk" ]]; then
            cp "$quest_apk" "ci-artifacts/android/wavry-quest-android-arm64-release.apk"
          fi

          if [[ -z "$mobile_apk" && -z "$quest_apk" ]]; then
            echo "No expected Android release APKs were produced." >&2
            exit 1
          fi
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: android-arm64-v${{ needs.pre-build.outputs.wavry_version }}
          path: ci-artifacts/android/

  macos-swift:
    name: macOS Swift app
    needs: pre-build
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Build
        run: ./scripts/build-macos.sh release
      - name: Stage
        shell: bash
        run: |
          mkdir -p ci-artifacts/macos-app
          app_path="dist/Wavry.app"
          if [[ ! -d "$app_path" ]]; then
            echo "Native macOS app bundle not found at $app_path" >&2
            exit 1
          fi
          hdiutil create \
            -volname "Wavry" \
            -srcfolder "$app_path" \
            -ov \
            -format UDZO \
            "ci-artifacts/macos-app/wavry-desktop-native-macos-arm64.dmg"
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: macos-app-v${{ needs.pre-build.outputs.wavry_version }}
          path: ci-artifacts/macos-app/

  release:
    name: Create Release
    needs: [pre-build, rust-tests, smoke-tests, rust-backend, desktop-tauri, android, macos-swift]
    if: |
      always() &&
      (needs.rust-tests.result == 'success' || needs.rust-tests.result == 'skipped') &&
      (needs.smoke-tests.result == 'success' || needs.smoke-tests.result == 'skipped') &&
      (needs.rust-backend.result == 'success' || needs.rust-backend.result == 'skipped') &&
      (needs.desktop-tauri.result == 'success' || needs.desktop-tauri.result == 'skipped') &&
      (needs.android.result == 'success' || needs.android.result == 'skipped') &&
      (needs.macos-swift.result == 'success' || needs.macos-swift.result == 'skipped') &&
      github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Collect release assets
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          mkdir -p release-assets

          # Infrastructure/service binaries.
          for file in artifacts/backend-*/*; do
            base="$(basename "$file")"
            case "$base" in
              wavry-master-*|wavry-gateway-*|wavry-relay-*|wavry-server-*)
                cp "$file" "release-assets/$base"
                ;;
            esac
          done

          # Desktop app artifacts (Tauri).
          for file in artifacts/desktop-*/*; do
            base="$(basename "$file")"
            case "$base" in
              wavry-desktop-tauri-*)
                cp "$file" "release-assets/$base"
                ;;
            esac
          done

          # Native macOS app bundle artifacts.
          for file in artifacts/macos-app-*/*; do
            base="$(basename "$file")"
            case "$base" in
              wavry-desktop-native-macos-*.dmg)
                cp "$file" "release-assets/$base"
                ;;
            esac
          done

          # Android release APKs.
          for file in artifacts/android-*/*.apk; do
            base="$(basename "$file")"
            case "$base" in
              wavry-mobile-android-arm64-release.apk|wavry-quest-android-arm64-release.apk)
                cp "$file" "release-assets/$base"
                ;;
            esac
          done

          required=(
            "release-assets/wavry-master-*"
            "release-assets/wavry-gateway-*"
            "release-assets/wavry-relay-*"
            "release-assets/wavry-server-*"
          )
          for pattern in "${required[@]}"; do
            if ! compgen -G "$pattern" > /dev/null; then
              echo "Missing required release asset matching: $pattern" >&2
              exit 1
            fi
          done

          count="$(find release-assets -type f | wc -l | tr -d ' ')"
          if [[ "$count" == "0" ]]; then
            echo "No release assets were collected." >&2
            exit 1
          fi
      - name: Checksums
        run: |
          cd release-assets
          find . -type f -exec sha256sum {} + > ../SHA256SUMS.txt
      - name: Generate asset manifest
        shell: bash
        run: |
          {
            echo "# Wavry Release Assets"
            echo
            echo "| File | Description |"
            echo "|---|---|"
            while IFS= read -r file; do
              desc="Release artifact"
              case "$file" in
                wavry-master-*) desc="Master coordination service binary" ;;
                wavry-gateway-*) desc="Gateway control-plane service binary" ;;
                wavry-relay-*) desc="Relay forwarding service binary" ;;
                wavry-server-*) desc="Host runtime service binary" ;;
                wavry-desktop-tauri-linux-*) desc="Desktop app (Tauri) for Linux" ;;
                wavry-desktop-tauri-windows-*.exe) desc="Desktop app (Tauri) for Windows" ;;
                wavry-desktop-tauri-macos-*.dmg) desc="Desktop app (Tauri) for macOS (DMG)" ;;
                wavry-desktop-native-macos-*.dmg) desc="Native Swift desktop app for macOS (DMG)" ;;
                wavry-mobile-android-arm64-release.apk) desc="Android mobile client (arm64 release APK)" ;;
                wavry-quest-android-arm64-release.apk) desc="Android Quest client (arm64 release APK)" ;;
              esac
              echo "| \`$file\` | $desc |"
            done < <(find release-assets -maxdepth 1 -type f -printf '%f\n' | sort)
          } > RELEASE_ASSETS.md
      - name: Delete existing release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ needs.pre-build.outputs.wavry_version }}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release view "$TAG" --json assets --jq '.assets[].name' \
              | xargs -I{} gh release delete-asset "$TAG" "{}" --yes 2>/dev/null || true
          fi
      - name: GH Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.pre-build.outputs.wavry_version }}
          name: Wavry v${{ needs.pre-build.outputs.wavry_version }}
          generate_release_notes: true
          allow_updates: true
          prerelease: ${{ contains(needs.pre-build.outputs.wavry_version, 'canary') || contains(needs.pre-build.outputs.wavry_version, 'beta') || contains(needs.pre-build.outputs.wavry_version, 'unstable') }}
          body: |
            Wavry Core: v${{ needs.pre-build.outputs.wavry_version }}
            RIFT Protocol: v${{ needs.pre-build.outputs.rift_version }}
            DELTA CC: v${{ needs.pre-build.outputs.delta_version }}
          files: |
            release-assets/*
            SHA256SUMS.txt
            RELEASE_ASSETS.md
