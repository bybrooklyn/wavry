name: Platform Builds

on:
  pull_request:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: platform-builds-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RELEASE_ICON_PATH: crates/wavry-desktop/src-tauri/icons/icon.png
  RELEASE_ICON_NAME: WavryLogo.png

jobs:
  rust-tests:
    name: Rust smoke tests
    runs-on: ubuntu-latest
    # ... (existing rust-tests steps)

  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            protobuf-compiler \
            libsqlite3-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libasound2-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage report
        run: cargo tarpaulin --workspace --timeout 120 --out Xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./tarpaulin-report.xml
          fail_ci_if_error: false

  gateway-auth-smoke:
    name: Gateway auth smoke
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            protobuf-compiler \
            libsqlite3-dev \
            curl

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Provision infrastructure secrets
        run: ./scripts/provision-infrastructure.sh ./secrets

      - name: Run gateway auth smoke script
        run: |
          source ./secrets/wavry.env
          ./scripts/gateway-auth-smoke.sh

  master-relay-smoke:
    name: Master/relay smoke
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            protobuf-compiler \
            curl

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Provision infrastructure secrets
        run: ./scripts/provision-infrastructure.sh ./secrets

      - name: Run master/relay smoke script
        run: |
          source ./secrets/wavry.env
          ./scripts/master-relay-smoke.sh

  rust-backend:
    name: Rust backend (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_suffix: linux
            exe_ext: ""
          - os: macos-14
            artifact_suffix: macos
            exe_ext: ""
          - os: windows-latest
            artifact_suffix: windows
            exe_ext: ".exe"
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            protobuf-compiler \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libasound2-dev \
            libx11-dev \
            libxtst-dev \
            libxrandr-dev \
            libxi-dev \
            libevdev-dev \
            libudev-dev \
            libsqlite3-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build Rust backend packages
        run: |
          cargo build --locked --release \
            -p rift-core \
            -p rift-crypto \
            -p wavry-common \
            -p wavry-master \
            -p wavry-gateway \
            -p wavry-relay \
            -p wavry-server \
            -p wavry-client \
            -p wavry-cli \
            -p wavry-ffi

      - name: Sign Windows Binaries
        if: runner.os == 'Windows' && env.WINDOWS_PFX != '' && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        shell: pwsh
        env:
          WINDOWS_PFX: ${{ secrets.WINDOWS_CERTIFICATE_P12 }}
        run: |
          $certPath = "release.pfx"
          [System.Convert]::FromBase64String("${{ secrets.WINDOWS_CERTIFICATE_P12 }}") | Set-Content $certPath -Encoding Byte
          $bins = Get-ChildItem -Path target/release/*.exe, target/release/*.lib
          foreach ($bin in $bins) {
            & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe" sign /f $certPath /p "${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}" /t http://timestamp.digicert.com /v $bin.FullName
          }
          Remove-Item $certPath

      - name: Stage backend artifacts
        run: |
          mkdir -p ci-artifacts/backend
          ext='${{ matrix.exe_ext }}'
          bins=(wavry-master wavry-gateway wavry-relay wavry-server wavry-client wavry)
          for bin in "${bins[@]}"; do
            cp "target/release/${bin}${ext}" "ci-artifacts/backend/${bin}${ext}"
          done

          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cp target/release/wavry_ffi.lib ci-artifacts/backend/
          else
            cp target/release/libwavry_ffi.a ci-artifacts/backend/
          fi

          if [[ ! -f "${RELEASE_ICON_PATH}" ]]; then
            echo "Release icon not found: ${RELEASE_ICON_PATH}" >&2
            exit 1
          fi
          cp "${RELEASE_ICON_PATH}" "ci-artifacts/backend/${RELEASE_ICON_NAME}"
          for artifact in ci-artifacts/backend/*; do
            if [[ -f "${artifact}" && "${artifact}" != *.png ]]; then
              cp "${RELEASE_ICON_PATH}" "${artifact}.logo.png"
            fi
          done

      - name: Upload backend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.artifact_suffix }}
          path: ci-artifacts/backend/
          if-no-files-found: error

  desktop-ui:
    name: Desktop UI typecheck
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Bun
        uses: oven-sh/setup-bun@v2

      - name: Install desktop dependencies
        working-directory: crates/wavry-desktop
        run: bun install --frozen-lockfile

      - name: Run desktop checks
        working-directory: crates/wavry-desktop
        run: bun run check

  desktop-tauri:
    name: Desktop Tauri build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_suffix: linux
            exe_ext: ""
          - os: macos-14
            artifact_suffix: macos
            exe_ext: ""
          - os: windows-latest
            artifact_suffix: windows
            exe_ext: ".exe"
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install Linux desktop dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            protobuf-compiler \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libasound2-dev \
            libx11-dev \
            libxtst-dev \
            libxrandr-dev \
            libxi-dev \
            libevdev-dev \
            libudev-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

          if apt-cache show libwebkit2gtk-4.1-dev >/dev/null 2>&1; then
            sudo apt-get install -y --no-install-recommends libwebkit2gtk-4.1-dev
          elif apt-cache show libwebkit2gtk-4.0-dev >/dev/null 2>&1; then
            sudo apt-get install -y --no-install-recommends libwebkit2gtk-4.0-dev
          else
            echo "Neither libwebkit2gtk-4.1-dev nor libwebkit2gtk-4.0-dev is available on this runner image." >&2
            exit 1
          fi

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build desktop Tauri app
        run: cargo build --locked --release -p wavry-desktop

      - name: Stage desktop artifacts
        run: |
          mkdir -p ci-artifacts/desktop
          ext='${{ matrix.exe_ext }}'
          candidates=(wavry-desktop wavry_desktop)
          copied=0
          for name in "${candidates[@]}"; do
            if [[ -f "target/release/${name}${ext}" ]]; then
              cp "target/release/${name}${ext}" "ci-artifacts/desktop/${name}${ext}"
              copied=1
            fi
          done

          if [[ "$copied" -ne 1 ]]; then
            echo "No desktop binary found under target/release" >&2
            ls -la target/release >&2 || true
            exit 1
          fi

          if [[ ! -f "${RELEASE_ICON_PATH}" ]]; then
            echo "Release icon not found: ${RELEASE_ICON_PATH}" >&2
            exit 1
          fi
          cp "${RELEASE_ICON_PATH}" "ci-artifacts/desktop/${RELEASE_ICON_NAME}"
          for artifact in ci-artifacts/desktop/*; do
            if [[ -f "${artifact}" && "${artifact}" != *.png ]]; then
              cp "${RELEASE_ICON_PATH}" "${artifact}.logo.png"
            fi
          done

      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-tauri-${{ matrix.artifact_suffix }}
          path: ci-artifacts/desktop/
          if-no-files-found: error

  android:
    name: Android (mobile + quest)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    env:
      WAVRY_ANDROID_RELEASE_STORE_FILE: ${{ github.workspace }}/release.jks
      WAVRY_ANDROID_RELEASE_STORE_PASSWORD: ${{ secrets.WAVRY_ANDROID_RELEASE_STORE_PASSWORD }}
      WAVRY_ANDROID_RELEASE_KEY_ALIAS: ${{ secrets.WAVRY_ANDROID_RELEASE_KEY_ALIAS }}
      WAVRY_ANDROID_RELEASE_KEY_PASSWORD: ${{ secrets.WAVRY_ANDROID_RELEASE_KEY_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decode Keystore
        if: env.WAVRY_ANDROID_RELEASE_STORE_PASSWORD != ''
        run: echo "${{ secrets.WAVRY_ANDROID_RELEASE_KEYSTORE_B64 }}" | base64 -d > release.jks

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses || true

      - name: Install Android NDK + CMake
        run: sdkmanager --install "ndk;26.3.11579264" "cmake;3.22.1"

      - name: Add Rust Android targets
        run: rustup target add aarch64-linux-android x86_64-linux-android

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --locked

      - name: Build Android mobile + quest debug APKs
        run: ./scripts/dev-android.sh --both --release --no-install --no-ndk-install

      - name: Stage Android artifacts
        run: |
          mkdir -p ci-artifacts/android

          if [[ ! -f "${RELEASE_ICON_PATH}" ]]; then
            echo "Release icon not found: ${RELEASE_ICON_PATH}" >&2
            exit 1
          fi
          cp "${RELEASE_ICON_PATH}" "ci-artifacts/android/${RELEASE_ICON_NAME}"

          copied=0
          while IFS= read -r -d '' file; do
            base="$(basename "${file}")"
            cp "${file}" "ci-artifacts/android/${base}"
            cp "${RELEASE_ICON_PATH}" "ci-artifacts/android/${base}.logo.png"
            copied=1
          done < <(
            find apps/android/app/build/outputs -type f \
              \( -path "*/release/*.apk" -o -path "*/release/*.aab" \) -print0
          )

          while IFS= read -r -d '' file; do
            base="$(basename "${file}")"
            cp "${file}" "ci-artifacts/android/${base}"
            cp "${RELEASE_ICON_PATH}" "ci-artifacts/android/${base}.logo.png"
            copied=1
          done < <(
            find apps/android/app/src/main/cpp/prebuilt -type f -name "libwavry_ffi.a" -print0
          )

          if [[ "${copied}" -ne 1 ]]; then
            echo "No Android release artifacts were staged." >&2
            exit 1
          fi

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apks
          path: ci-artifacts/android/
          if-no-files-found: error

  macos-app:
    name: macOS Swift app build
    runs-on: macos-14
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build macOS app package
        working-directory: apps/macos
        run: swift build -c release

      - name: Ad-hoc Sign FFI and App
        run: |
          codesign --force --deep --sign - target/release/libwavry_ffi.a
          codesign --force --deep --sign - apps/macos/.build/release/WavryMacOS

      - name: Stage macOS app artifacts
        run: |
          mkdir -p ci-artifacts/macos-app
          cp apps/macos/.build/release/WavryMacOS ci-artifacts/macos-app/
          cp target/release/libwavry_ffi.a ci-artifacts/macos-app/

          if [[ ! -f "${RELEASE_ICON_PATH}" ]]; then
            echo "Release icon not found: ${RELEASE_ICON_PATH}" >&2
            exit 1
          fi
          cp "${RELEASE_ICON_PATH}" "ci-artifacts/macos-app/${RELEASE_ICON_NAME}"
          for artifact in ci-artifacts/macos-app/*; do
            if [[ -f "${artifact}" && "${artifact}" != *.png ]]; then
              cp "${RELEASE_ICON_PATH}" "${artifact}.logo.png"
            fi
          done

      - name: Upload macOS app artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: ci-artifacts/macos-app/
          if-no-files-found: error

  github-release:
    name: Publish GitHub release
    runs-on: ubuntu-latest
    needs:
      - rust-tests
      - gateway-auth-smoke
      - master-relay-smoke
      - rust-backend
      - desktop-ui
      - desktop-tauri
      - android
      - macos-app
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Generate checksums
        run: |
          cd release-artifacts
          find . -type f -print0 | sort -z | xargs -0 sha256sum > SHA256SUMS.txt

      - name: Sign checksums with GPG
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Create detached GPG signature
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        run: |
          cd release-artifacts
          gpg --batch --yes --armor --detach-sign SHA256SUMS.txt

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            release-artifacts/**/*
          fail_on_unmatched_files: true
