name: Platform Builds

on:
  pull_request:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: platform-builds-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-tests:
    name: Rust smoke tests
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            protobuf-compiler \
            libsqlite3-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Run targeted smoke tests
        run: |
          cargo test --locked -p wavry-common
          cargo test --locked -p wavry-relay
          cargo test --locked -p wavry-gateway

  gateway-auth-smoke:
    name: Gateway auth smoke
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            protobuf-compiler \
            libsqlite3-dev \
            curl

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Run gateway auth smoke script
        run: ./scripts/gateway-auth-smoke.sh

  master-relay-smoke:
    name: Master/relay smoke
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            protobuf-compiler \
            curl

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Run master/relay smoke script
        run: ./scripts/master-relay-smoke.sh

  rust-backend:
    name: Rust backend (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_suffix: linux
            exe_ext: ""
          - os: macos-14
            artifact_suffix: macos
            exe_ext: ""
          - os: windows-latest
            artifact_suffix: windows
            exe_ext: ".exe"
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            protobuf-compiler \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libx11-dev \
            libxtst-dev \
            libxrandr-dev \
            libxi-dev \
            libevdev-dev \
            libudev-dev \
            libsqlite3-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build Rust backend packages
        run: |
          cargo build --locked --release \
            -p rift-core \
            -p rift-crypto \
            -p wavry-common \
            -p wavry-master \
            -p wavry-gateway \
            -p wavry-relay \
            -p wavry-server \
            -p wavry-client \
            -p wavry-cli \
            -p wavry-ffi

      - name: Stage backend artifacts
        run: |
          mkdir -p ci-artifacts/backend
          ext='${{ matrix.exe_ext }}'
          bins=(wavry-master wavry-gateway wavry-relay wavry-server wavry-client wavry)
          for bin in "${bins[@]}"; do
            cp "target/release/${bin}${ext}" "ci-artifacts/backend/${bin}${ext}"
          done

          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cp target/release/wavry_ffi.lib ci-artifacts/backend/
          else
            cp target/release/libwavry_ffi.a ci-artifacts/backend/
          fi

      - name: Upload backend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.artifact_suffix }}
          path: ci-artifacts/backend/
          if-no-files-found: error

  desktop-ui:
    name: Desktop UI typecheck
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Bun
        uses: oven-sh/setup-bun@v2

      - name: Install desktop dependencies
        working-directory: crates/wavry-desktop
        run: bun install --frozen-lockfile

      - name: Run desktop checks
        working-directory: crates/wavry-desktop
        run: bun run check

  desktop-tauri:
    name: Desktop Tauri build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_suffix: linux
            exe_ext: ""
          - os: macos-14
            artifact_suffix: macos
            exe_ext: ""
          - os: windows-latest
            artifact_suffix: windows
            exe_ext: ".exe"
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install Linux desktop dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            protobuf-compiler \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libx11-dev \
            libxtst-dev \
            libxrandr-dev \
            libxi-dev \
            libevdev-dev \
            libudev-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

          if dpkg -s libwebkit2gtk-4.1-dev >/dev/null 2>&1; then
            sudo apt-get install -y --no-install-recommends libwebkit2gtk-4.1-dev
          else
            sudo apt-get install -y --no-install-recommends libwebkit2gtk-4.0-dev
          fi

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build desktop Tauri app
        run: cargo build --locked --release -p wavry-desktop

      - name: Stage desktop artifacts
        run: |
          mkdir -p ci-artifacts/desktop
          ext='${{ matrix.exe_ext }}'
          candidates=(wavry-desktop wavry_desktop)
          copied=0
          for name in "${candidates[@]}"; do
            if [[ -f "target/release/${name}${ext}" ]]; then
              cp "target/release/${name}${ext}" "ci-artifacts/desktop/${name}${ext}"
              copied=1
            fi
          done

          if [[ "$copied" -ne 1 ]]; then
            echo "No desktop binary found under target/release" >&2
            ls -la target/release >&2 || true
            exit 1
          fi

      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-tauri-${{ matrix.artifact_suffix }}
          path: ci-artifacts/desktop/
          if-no-files-found: error

  android:
    name: Android (mobile + quest)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses || true

      - name: Install Android NDK + CMake
        run: sdkmanager --install "ndk;26.3.11579264" "cmake;3.22.1"

      - name: Add Rust Android targets
        run: rustup target add aarch64-linux-android x86_64-linux-android

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --locked

      - name: Build Android mobile + quest debug APKs
        run: ./scripts/dev-android.sh --both --release --no-install --no-ndk-install

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apks
          path: |
            apps/android/app/build/outputs/apk/**/release/*.apk
            apps/android/app/build/outputs/bundle/**/release/*.aab
            apps/android/app/src/main/cpp/prebuilt/**/libwavry_ffi.a
          if-no-files-found: error

  macos-app:
    name: macOS Swift app build
    runs-on: macos-14
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build wavry-ffi static library
        run: cargo build --locked --release -p wavry-ffi

      - name: Build macOS app package
        working-directory: apps/macos
        run: swift build -c release

      - name: Stage macOS app artifacts
        run: |
          mkdir -p ci-artifacts/macos-app
          cp apps/macos/.build/release/WavryMacOS ci-artifacts/macos-app/
          cp target/release/libwavry_ffi.a ci-artifacts/macos-app/

      - name: Upload macOS app artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: ci-artifacts/macos-app/
          if-no-files-found: error
