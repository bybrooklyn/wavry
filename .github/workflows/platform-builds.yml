name: Platform Builds

on:
  pull_request:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: platform-builds-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RELEASE_ICON_PATH: crates/wavry-desktop/src-tauri/icons/icon.png
  RELEASE_ICON_NAME: WavryLogo.png
  MACOSX_DEPLOYMENT_TARGET: "14.0"

jobs:
  pre-build:
    name: Prepare build
    runs-on: ubuntu-latest
    outputs:
      wavry_version: ${{ steps.version.outputs.wavry_version }}
      rift_version: ${{ steps.version.outputs.rift_version }}
      delta_version: ${{ steps.version.outputs.delta_version }}
      already_released: ${{ steps.check_release.outputs.already_released }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse VERSION file
        id: version
        run: |
          WAVRY_V=$(grep "WAVRY" VERSION | awk '{print $2}' | sed 's/^v//')
          RIFT_V=$(grep "RIFT" VERSION | awk '{print $2}' | sed 's/^v//')
          DELTA_V=$(grep "DELTA" VERSION | awk '{print $2}' | sed 's/^v//')
          echo "wavry_version=$WAVRY_V" >> $GITHUB_OUTPUT
          echo "rift_version=$RIFT_V" >> $GITHUB_OUTPUT
          echo "delta_version=$DELTA_V" >> $GITHUB_OUTPUT
          echo "WAVRY_V=$WAVRY_V" >> $GITHUB_ENV
          echo "Extracted Wavry Version: $WAVRY_V"

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if version already released
        id: check_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="v${{ env.WAVRY_V }}"
          if gh release view "$VERSION" >/dev/null 2>&1; then
            echo "Version $VERSION already exists in releases."
            if [[ "${{ github.ref_type }}" == "tag" ]]; then
              echo "Git tag detected, proceeding with build anyway."
              echo "already_released=false" >> $GITHUB_OUTPUT
            else
              echo "Skipping build for existing version."
              echo "already_released=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "Version $VERSION does not exist yet."
            echo "already_released=false" >> $GITHUB_OUTPUT
          fi

  rust-tests:
    name: Rust tests
    needs: pre-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config protobuf-compiler libsqlite3-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libasound2-dev libx11-dev libxtst-dev libxrandr-dev libxi-dev libevdev-dev libudev-dev libgtk-3-dev libwebkit2gtk-4.1-dev libsoup-3.0-dev libayatana-appindicator3-dev librsvg2-dev libgl-dev
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache
        uses: Swatinem/rust-cache@v2
      - name: Run tests
        run: cargo test --workspace --locked

  smoke-tests:
    name: Smoke tests
    needs: pre-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config protobuf-compiler libsqlite3-dev curl
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache
        uses: Swatinem/rust-cache@v2
      - name: Provision Secrets
        run: ./scripts/provision-infrastructure.sh ./secrets
      - name: Gateway Auth Smoke
        run: |
          source ./secrets/wavry.env
          ./scripts/gateway-auth-smoke.sh
      - name: Master/Relay Smoke
        run: |
          source ./secrets/wavry.env
          ./scripts/master-relay-smoke.sh

  rust-backend:
    name: Build backend (${{ matrix.suffix }})
    needs: pre-build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            suffix: linux
            exe: ""
          - os: macos-14
            suffix: macos
            exe: ""
          - os: windows-latest
            suffix: windows
            exe: ".exe"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config protobuf-compiler libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libasound2-dev libx11-dev libxtst-dev libxrandr-dev libxi-dev libevdev-dev libudev-dev libsqlite3-dev libgtk-3-dev libwebkit2gtk-4.1-dev libsoup-3.0-dev libayatana-appindicator3-dev librsvg2-dev libgl-dev
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache
        uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --release --locked -p wavry-master -p wavry-gateway -p wavry-relay -p wavry-server -p wavry-client -p wavry-cli -p wavry-ffi
      - name: Stage
        shell: bash
        run: |
          mkdir -p ci-artifacts/backend
          bins=(wavry-master wavry-gateway wavry-relay wavry-server wavry-client wavry)
          for b in "${bins[@]}"; do
            if [[ -f "target/release/${b}${{ matrix.exe }}" ]]; then
              cp "target/release/${b}${{ matrix.exe }}" "ci-artifacts/backend/${b}-${{ matrix.suffix }}${{ matrix.exe }}"
            fi
          done
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.suffix }}-v${{ needs.pre-build.outputs.wavry_version }}
          path: ci-artifacts/backend/

  desktop-tauri:
    name: Desktop build (${{ matrix.suffix }})
    needs: pre-build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            suffix: linux
          - os: macos-14
            suffix: macos
          - os: windows-latest
            suffix: windows
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install Bun
        uses: oven-sh/setup-bun@v2
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config protobuf-compiler libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libasound2-dev libx11-dev libxtst-dev libxrandr-dev libxi-dev libevdev-dev libudev-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev patchelf libwebkit2gtk-4.1-dev libsoup-3.0-dev libgl-dev || sudo apt-get install -y libwebkit2gtk-4.0-dev
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache
        uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --release --locked -p wavry-desktop
      - name: Stage
        shell: bash
        run: |
          mkdir -p ci-artifacts/desktop
          for name in wavry-desktop wavry_desktop; do
            if [[ -f "target/release/${name}${{ matrix.exe }}" ]]; then
              cp "target/release/${name}${{ matrix.exe }}" "ci-artifacts/desktop/wavry-desktop-${{ matrix.suffix }}${{ matrix.exe }}"
              break
            fi
          done
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.suffix }}-v${{ needs.pre-build.outputs.wavry_version }}
          path: ci-artifacts/desktop/

  android:
    name: Android build
    needs: pre-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: 'gradle'
      - name: Setup SDK
        uses: android-actions/setup-android@v3
      
      - name: Cache NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: /usr/local/lib/android/sdk/ndk/26.3.11579264
          key: ndk-26.3.11579264

      - name: Install NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: sdkmanager --install "ndk;26.3.11579264" "cmake;3.22.1"
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android, x86_64-linux-android
      
      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          key: android-target

      - name: Cache cargo-ndk
        id: cache-cargo-ndk
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-ndk
          key: cargo-ndk-${{ runner.os }}-3

      - name: Install cargo-ndk
        if: steps.cache-cargo-ndk.outputs.cache-hit != 'true'
        run: cargo install cargo-ndk

      - name: Build
        run: ./scripts/dev-android.sh --both --release --no-install --no-ndk-install
      - name: Stage
        run: |
          mkdir -p ci-artifacts/android
          find apps/android/app/build/outputs -name "*.apk" -exec cp {} ci-artifacts/android/ \;
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: android-v${{ needs.pre-build.outputs.wavry_version }}
          path: ci-artifacts/android/

  macos-swift:
    name: macOS Swift app
    needs: pre-build
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Build
        run: ./scripts/build-macos.sh release
      - name: Stage
        run: |
          mkdir -p ci-artifacts/macos-app
          cd dist && zip -r "../ci-artifacts/macos-app/Wavry-macos.zip" Wavry.app
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: macos-app-v${{ needs.pre-build.outputs.wavry_version }}
          path: ci-artifacts/macos-app/

  release:
    name: Create Release
    needs: [pre-build, rust-tests, smoke-tests, rust-backend, desktop-tauri, android, macos-swift]
    if: |
      always() &&
      (needs.rust-tests.result == 'success' || needs.rust-tests.result == 'skipped') &&
      (needs.smoke-tests.result == 'success' || needs.smoke-tests.result == 'skipped') &&
      (needs.rust-backend.result == 'success' || needs.rust-backend.result == 'skipped') &&
      (needs.desktop-tauri.result == 'success' || needs.desktop-tauri.result == 'skipped') &&
      (needs.android.result == 'success' || needs.android.result == 'skipped') &&
      (needs.macos-swift.result == 'success' || needs.macos-swift.result == 'skipped') &&
      github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Checksums
        run: |
          cd artifacts
          find . -type f -exec sha256sum {} + > ../SHA256SUMS.txt
      - name: GH Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.pre-build.outputs.wavry_version }}
          name: Wavry v${{ needs.pre-build.outputs.wavry_version }}
          generate_release_notes: true
          allow_updates: true
          prerelease: ${{ contains(needs.pre-build.outputs.wavry_version, 'canary') || contains(needs.pre-build.outputs.wavry_version, 'beta') || contains(needs.pre-build.outputs.wavry_version, 'unstable') }}
          body: |
            Wavry Core: v${{ needs.pre-build.outputs.wavry_version }}
            RIFT Protocol: v${{ needs.pre-build.outputs.rift_version }}
            DELTA CC: v${{ needs.pre-build.outputs.delta_version }}
          files: |
            artifacts/**/*
            SHA256SUMS.txt
